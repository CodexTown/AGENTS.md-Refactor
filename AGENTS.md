# AGENTS: Рефакторинг легаси-кода

Этот файл описывает общие правила и агентов для автоматизированного рефакторинга кода с опорой на единый стиль проекта.

---

## 1. ГЛОБАЛЬНЫЕ ИНВАРИАНТЫ

1. **STYLEGUIDE.md всегда в корне репозитория.**
   - Путь: `./STYLEGUIDE.md`.
   - Доступ агентов:
     - `READ: ./STYLEGUIDE.md`
     - **ЗАПРЕЩЕНО:** любые `WRITE` / `DELETE` / модификации.
   - `STYLEGUIDE.md` — единственный источник истины по стилю, типизации и docstrings.

2. **Входные файлы — только в поддиректории `_in`.**
   - Входной код и исходные тесты располагаются в:
     - `./_in/**/*.py`
   - Для всех агентов:
     - Разрешено: `READ` в `./_in`.
     - **Запрещено:** `WRITE` / `DELETE` в `./_in`.
   - `_in` — read-only зона, эталонное легаси-состояние.

3. **Результаты работы — только в поддиректории `_out`.**
   - Все модифицированные версии файлов и новые артефакты записываются в:
     - `./_out/**/*.py`
   - Для всех агентов:
     - Разрешено: `WRITE` / `CREATE` в `./_out`.
     - Структура путей должна сохранять соответствие:  
       если входной файл `./_in/foo/bar.py`, результат — `./_out/foo/bar.py`.
   - **Запрещено:** создавать или изменять файлы вне `_out` (кроме чтения `STYLEGUIDE.md`).

4. **Инвариант поведения.**
   - Рефакторинг не должен менять наблюдаемое поведение кода:
     - сигнатуры публичных функций (если иное явно не разрешено);
     - контракты ввода/вывода;
     - порядок и семантику побочных эффектов.
   - Любое потенциальное изменение поведения должно быть явно отмечено в комментариях и, по возможности, вынесено в отдельный шаг.

5. **Минимально достаточные изменения.**
   - Правки сфокусированы на:
     - структуре;
     - стиле и типизации;
     - docstrings.
   - Запрещено «переписывать всё» без явной необходимости.

---

## 2. ТИПОВОЙ СЦЕНАРИЙ: РЕФАКТОРИНГ ЛЕГАСИ-ФАЙЛА

**Контекст:**

- В каталоге `_in` есть файл с легаси-кодом, например:
  - `./_in/legacy_processor.py`
- В корне лежит стайлгайд:
  - `./STYLEGUIDE.md`
- Результирующие файлы (переработанный код и тесты) пишутся в:
  - `./_out/legacy_processor.py`
  - `./_out/test_processor.py` (или другое имя по договорённости).

**Цель:**

- Привести код к требованиям `STYLEGUIDE.md`:
  - разбить большие функции;
  - добавить аннотации типов;
  - добавить docstrings;
  - не менять логику работы.
- Сгенерировать unit-тесты в `_out`.

---

## 3. ОРКЕСТРАТОР

### AGENT: `orchestrator.legacy_refactor`

**Роль:**  
Координация процесса: выбор целевого файла в `_in`, чтение стайлгайда, делегирование задач профильным агентам, запись результатов в `_out`, запуск тестов.

**Допустимые действия:**

- `READ`:
  - `./STYLEGUIDE.md`
  - `./_in/**/*.py`
  - `./_out/**/*.py` (для показа диффов и запуска тестов)
- `WRITE`:
  - `./_out/**/*.py`
- `RUN`:
  - `pytest`
  - `pytest -q`
  - `python -m pytest`

**Алгоритм работы:**

1. **Подготовка:**
   - Получить от пользователя указание входного файла из `_in`, например:  
     > «Рефактори `@_in/legacy_processor.py`…»
   - Прочитать:
     - `./STYLEGUIDE.md`;
     - `./_in/legacy_processor.py`.

2. **Рефакторинг:**
   - Сформировать задание для `dev.legacy_refactorer`:
     - входной путь: `./_in/legacy_processor.py`;
     - целевой путь результата: `./_out/legacy_processor.py`;
     - выдержки / ключевые правила из `STYLEGUIDE.md`;
     - явная инструкция «не менять логику работы».
   - Получить от `dev.legacy_refactorer` переработанный текст.
   - Записать результат только в `_out`, не изменяя `_in`.
   - Сформировать и показать дифф:
     - сравнение `./_in/legacy_processor.py` и `./_out/legacy_processor.py`;
     - список новых/изменённых функций, добавленных типов и docstrings.

3. **Тесты:**
   - По запросу пользователя, например:  
     > «Теперь напиши unit-тесты для новых функций в файле `_out/test_processor.py`.»
   - Вызвать `qa.test_writer`:
     - передать путь к переработанному модулю в `_out`, например: `./_out/legacy_processor.py`;
     - указать целевой файл тестов: `./_out/test_processor.py` (или другую структуру, но внутри `_out`).
   - После записи тестов:
     - запустить `pytest`, настроенный так, чтобы видеть модули и тесты из `_out` (через PYTHONPATH, `conftest.py` или отдельную конфигурацию);
     - показать результат (пройденные тесты / ошибки).

4. **Выходные артефакты:**
   - исходный код в `_in` остаётся неизменным;
   - переработанный код и тесты — в `_out`;
   - протокол изменений (дифф) формируется на основе `_in` → `_out`.

---

## 4. АГЕНТ РЕФАКТОРИНГА

### AGENT: `dev.legacy_refactorer`

**Роль:**  
Структурный и стилистический рефакторинг одного входного файла из `_in` с записью результата в `_out` и опорой на `STYLEGUIDE.md`.

**Вход:**

- Входной путь: `./_in/…`, например: `./_in/legacy_processor.py`.
- Целевой путь результата: `./_out/…`, например: `./_out/legacy_processor.py`.
- Содержимое входного файла.
- Содержимое или выдержки `./STYLEGUIDE.md`.
- Инструкция «не менять логику работы» (по умолчанию).

**Выход:**

- Обновлённый текст модуля, записанный в указанный путь в `_out`.

**Ограничения по доступу:**

- `READ`:
  - `./STYLEGUIDE.md`
  - `./_in/**/*.py`
  - при необходимости — уже существующие файлы в `./_out/**/*.py` (для инкрементных правок)
- `WRITE`:
  - только в `./_out/**/*.py`
- **ЗАПРЕЩЕНО:**
  - любые изменения в `./_in`;
  - любые изменения `./STYLEGUIDE.md`;
  - создание файлов вне `./_out`.

**Правила работы:**

1. **Анализ структуры:**
   - Построить карту исходного файла:
     - функции, классы, точки входа;
     - подозрительно длинные функции;
     - места без типов и docstrings.
   - Сформировать план разбиения и улучшений.

2. **Разбиение функций:**
   - Выделять логические блоки в отдельные функции:
     - использовать говорящие имена по `STYLEGUIDE.md`;
     - выносить детали в приватные хелперы, если так допускает стайлгайд.
   - Сохранять внешний контракт публичных функций и последовательность побочных эффектов.

3. **Типизация:**
   - Добавлять аннотации типов ко всем функциям и ключевым структурам:
     - использовать `typing` и типы из стайлгайда;
     - при сомнении выбирать наиболее информативный и безопасный абстрактный тип.
   - При необходимости вводить `TypeAlias` (если это соответствует `STYLEGUIDE.md`).

4. **Docstrings и стиль:**
   - Добавлять docstrings к публичным функциям и, при необходимости, к важным внутренним.
   - Соблюдать формат и структуру docstrings из `STYLEGUIDE.md`.
   - Приводить форматирование к PEP 8 с учётом локальных правил (длина строк, импорты и т.д.).

5. **Запись результата:**
   - Формировать итоговый текст и записывать только в `./_out/...`.
   - Не модифицировать исходный файл в `_in`.

---

## 5. АГЕНТ ДЛЯ ТЕСТОВ

### AGENT: `qa.test_writer`

**Роль:**  
Создание или расширение набора unit-тестов для переработанного модуля в `_out`.

**Вход:**

- Путь к переработанному модулю в `_out`, например: `./_out/legacy_processor.py`.
- Путь к файлу тестов в `_out`, например: `./_out/test_processor.py` (может быть новым).
- Содержимое `STYLEGUIDE.md` при необходимости (правила структурирования тестов, нейминг и т.п.).

**Выход:**

- Обновлённый или созданный файл тестов в `./_out`.

**Ограничения по доступу:**

- `READ`:
  - `./STYLEGUIDE.md`
  - `./_in/**/*.py` (при необходимости свериться с исходным поведением)
  - `./_out/**/*.py`
- `WRITE`:
  - только в `./_out/**/*.py`
- **ЗАПРЕЩЕНО:**
  - любые `WRITE` / `DELETE` в `./_in`;
  - изменения `./STYLEGUIDE.md`;
  - создание файлов вне `./_out`.

**Правила работы:**

1. **Выбор целей тестирования:**
   - Основной фокус:
     - публичные функции переработанного модуля;
     - ключевые ветви логики;
     - граничные значения.
   - При наличии существующих тестов в `_out`:
     - не удалять без обоснования;
     - адаптировать при несовместимости.

2. **Стиль тестов:**
   - Использовать `pytest`:
     - функции вида `test_*`;
     - фикстуры для повторяющейся подготовки данных.
   - Имена тестов делаются описательными и связаны с проверяемым сценарием.

3. **Изоляция:**
   - Минимизировать внешние зависимости (время, сеть, глобальное состояние).
   - При необходимости использовать моки/заглушки.

4. **Размещение:**
   - Все тесты — внутри `_out`, например:
     - `./_out/test_processor.py`
     - или `./_out/tests/test_processor.py`  
       (структура выбирается и фиксируется на уровне проекта, но всегда в `_out`).

---

## 6. ПРИМЕРЫ ПОЛЬЗОВАТЕЛЬСКИХ ПРОМПТОВ

1. **Базовый рефакторинг:**

   > Рефактори файл `@_in/legacy_processor.py` согласно правилам из `@STYLEGUIDE.md`.  
   > Разбей большие функции на маленькие, добавь аннотации типов и docstrings.  
   > Результат запиши в `_out/legacy_processor.py`.  
   > Исходный файл в `_in` не изменяй.

2. **Генерация тестов:**

   > Напиши unit-тесты для функций из `_out/legacy_processor.py` в файле `_out/test_processor.py`.  
   > Используй `pytest` и покрой основные позитивные и граничные сценарии.  
   > Не создавай ничего вне папки `_out`.

3. **Запуск тестов (через оркестратора):**

   > Запусти `pytest` так, чтобы тесты из `_out` проверили модуль `_out/legacy_processor.py`, и покажи результат.

---

## 7. КРАТКИЙ СЦЕНАРИЙ ДЛЯ ДЕМО

1. Положить легаси-файл в `_in`:  
   `./_in/legacy_processor.py`.
2. Убедиться, что `STYLEGUIDE.md` лежит в корне и не изменяется агентами.
3. Запустить `orchestrator.legacy_refactor` с промптом для рефакторинга.  
   Результат будет в `./_out/legacy_processor.py`.
4. Посмотреть дифф между `_in/legacy_processor.py` и `_out/legacy_processor.py`.
5. Попросить `qa.test_writer` создать/обновить `./_out/test_processor.py`.
6. Запустить `pytest` для `_out` и показать, что тесты проходят.

